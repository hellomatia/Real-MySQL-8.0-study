# 트랜잭션과 잠금

## 목차

- [트랜잭션](#트랜잭션)
- [MySQL 엔진의 장금](#MySQL-엔진의-장금)
- [InnoDB 스토리지 엔진 잠금](#InnoDB-스토리지-엔진-잠금)



## Reference

- [Real MySQL 8.0 - 백은빈,이성욱 (지은이) ](https://product.kyobobook.co.kr/detail/S000060313997)

트랜잭션은 작업의 완전성을 보장해 주는 것이다. 즉 논리적인 작업 셋을 완벽하게 처리하거나, 처리하지 못할 경우 원 상태로 복구해서 작업의 일부만 적용되는 현상이 발생하지 않게 만들어준다.

잠금(Lock)과 트랜잭션은 서로 비슷한 개념이지만, 잠금은 동시성을 제저하기 위한 기능이고, 트랜잭션은 정합성을 보장하기 위한 기능이다. 잠금은 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 한 시점에는 하나의 커넥션만 변경할 수 있게 해주는 역할을 한다.

## 트랜잭션

MyISAM과 MEMORY 스토리지 엔진이 더 빠르다고 생각하고, InnoDB스토리지 엔진은 사용하기 복잡하고 번거럽다고 생각하지만, 사실 MyISAM이나 MEMORY같이 트랜잭션을 지원하지 않는 스토리지 엔진은 더 많은 고민거리를 만들어 낸다.

### MySQL에서의 트랜잭션

논리적인 작업셋의 개수 의 관계없이 논리적인 작업 셋 자체가 100%적용되거나, 아무것도 적용되지 않아야함을 보장해주는 것이다. 어떤 사용자는 트랜잭션이 상당히 골치 아픈 기능이라 생각하지만, 트랜잭션이란 그 만큼 애플리케이션 개발에서 고민해야 할 문제를 줄여주는 필수적인 기능이다.

### 주의사항

트랜잭션 또한 DBMS의 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하는 게 좋다. 프로그램 코드에서 트랜잭셩의 범위를 최소화하라는 의미이다. 프로그램의 코드가 데이터베이스 커넥션을 가지고 있는 범위와 트랜잭션이 활성화되어 있는 프로그램의 범위를 최소화해야 한다. 코드에서 라인수를 한두줄이라고 하더라도 네트워크 작업이 있는 경우 반드시 트랜잭션에서 배제해야 한다. 이런 실수로 DBMS서버가 높은 부하 상태로 빠지거나 위험한 상태에 빠지는 경우가 있다.

## MySQL 엔진의 장금

### 글로벌 락

글로벌 락은 FLUSH TABLES WITH READ LOCK명령으로 획득할 수 있다. 잠금 가운데 가장 범위가 크다. 한 세션에서 글로벌 락을 확득하면, 다른 세션에서 SELECT문을 제외한 DDL문장이나 DML문장을 실행하는 경우 락이 해제될때 까지 대기 상태로 남는다.

조금 더 가벼운 글로벌 락으로는 Xtrabackup이나 Enterprise Backup과 같은 백업 툴들의 안정적인 실행을 위해 백업 락이 도입되었다.

### 테이블 락

테이블 락은 개별 테이블 단위로 설정되는 잠금이며, 명시적 또는 묵시적으로 특정 테이블의 락을 획득할 수 있다. LOCK TABLES table_name [ READ | WRITE ] 명령어로 테이블의 락을 획득 UNLOCK TABLES명령어로 잠금을 반납할 수 있다.

### 네임드 락

네임드 락은 임의의 문자열에 대해 잠금을 설정할 수 있다.

### 메타데이터 락

데이터베이스 객체의 이름이나 구조를 변경하는 경우에 획득하는 잠금이다.

## InnoDB 스토리지 엔진 잠금

InnoDB 스토리지 엔진은 MySQL에서 제공하는 잠금과 별개로 스토리지 엔진 내부에서 레코드 기반의 잠금 방식을 탑재하고 있다.

### 레코드 락

레코드 자체만을 잠그는 것을 레코드 락이라 한다. InnoDB스토리지 엔진은 레코드 자체가 아니라 인덱스의 레코드를 잠근다. 인덱스가 하나도 없는 테이블이더라도 내부적으로 자동 생성된 클러스터 인덱스를 이용해 잠금을 설정한다.

### 갭 락

갭 락은 레코드 자체가 아니라 레코드와 바로 인접한 레코드 사이의 간격만을 잠그는 것을 의미한다. 갭 락의 역할은 레코드와 레코드 사이의 간격에 새로운 레코드가 생성되는 것을 제어해야 한다. 갭 락은 그 자체 보다 넥스트 키 락의 일부로 자주 사용된다.

### 넥스트 키 락

레코드 락과 갭 락을 합쳐 놓은 형태의 잠금을 넥스트 키 락이라 한다. InnoDB의 갭 락이나 넥스트 키락은 바이너리 로그에 기록되는 쿼리가 레플리키 서버에서 실행될 때 소스 서버에서 만들어 낸 결과와 동일한 결과를 만들어내도록 보장해주는 것이 주 목적이다.

### 자동 증가 락

MySQL에서 자동 증가 하는 숫자 값을 추출하기 위해 AUTO_INCREMENT라는 칼럼 속성을 제공한다. 동시에 여러 레코드가 INSERT되는 경우, 각 레코드는 중복되지 않고, 저장된 순서대로 증가하는 일련번호를 가져야 한다. 이를 위해 내부적으로 AUTO_INCREMENT락이라 하는 테이블 수준의 잠금을 사용한다. 자동 증가 값이 한 번 증가하면 절대 줄어들지 않는 이유가, AUTO_INCREMENT 잠금을 최소화 하기 위해서이다. INSERT 쿼리가 실패했더라도 한번 증가된 값은 다시 줄어들지 않는다.

### 인덱스와 잠금

InnoDB에서는 변경해야 할 레코드를 찾기 위해 검색한 인덱스의 레코드를 모두 락을 걸어야 한다.