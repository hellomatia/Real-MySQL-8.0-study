# 데이터 암호화

## 목차

- [MySQL 서버의 데이터 암호화](#MySQL-서버의-데이터-암호화)
- [언두 로그 및 리두 로그 암호화](#언두-로그-및-리두-로그-암호화)
- [바이너리 로그 암호화](#바이너리-로그-암호화)



## Reference

- [Real MySQL 8.0 - 백은빈,이성욱 (지은이) ](https://product.kyobobook.co.kr/detail/S000060313997)

MySQL 8.0으로 업그레이드되면서 데이터 파일뿐만 아니라 리두 로그나 언두 로그, 복제를 위한 바이너리 로그 등도 모두 암호화 기능을 지원하기 시작했다.

데이터 암호화는 보안 감사에서 필수적인 부분이며, 핀테크 서비스처럼 중요한 정보를 저장하는 서비스에서는 응용 프로그램에서 암호화한 데이터를 데이터베이스 서버에서 다시 암호화하는 이중 암호화 방법을 선택하기도 한다. 응용 프로그램에서는 칼럼 단위로, 데이터 베이스는 테이블 단위로 암호화 한다.

## MySQL 서버의 데이터 암호화

데이터베이스 서버와 디스크 사이의 테이터 읽고 쓰기 지점에서 암호화 또는 복호화를 수행한다. 따라서 MySQL 서버에서 디스크 입출력 이외의 부분에서는 암호화 처리가 전혀 필요하지 않다.  이러한 방식을 가리켜 TDE이라 한다.

### 2단계 키관리

MySQL 서버의 TDE에서 암호화 키는 키링 플로그인에 의해 관리된다. 다양한 플러그인이 제공되지만 마스터 키를 관리하는 방법만 다를 뿐 MySQL 서버 내부적으로 작동하는 방식은 모두 동일하다. 암호화는 마스터 키와 테이블스페이스 키라는 두 종류의 키를 가지고 있다. 암호화된 테이블이 생성될 때마다 해당 테이블을 위한 임의의 테이블 스페이스 키를 발급한다. MySQL 서버는 마스터 키를 이용해 테이블 스페이스 키를 암호화해서 각 테이블의 데이터 파일 헤더에 저장한다. 테이블 스페이스 키는 외부로 노출되지 않기에 주기적으로 변경하지 않아도 보안상 취약점이 되지 않는다. 하지만 마스터키는 외부의 파일을 이용하기에 노출될 가능성이 높다. 따라서 마스터키는 주기적으로 변경해야 한다.

### 암호화와 성능

디스크로부터 한 번 읽은 데이터 페이지는 복호화되어 InnoDB의 버퍼 풀에 적재된다. 따라서 데이터 페이지가 한 번 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다. 하지만 InnoDB버퍼 풀에 존재하지 않은 데이터 페이지를 읽어야 하는 겨우 복호화 과정을거치기에 쿼리가 지연된다.

같은 테이블에 대해 암호화와 압축이 동시에 적용되면 MySQL 서버는 압축을 먼저 실행하고 암호화를 적용한다.

- 암호화된 결과물은 아주 랜덤한 바이트의 배열을 가짐 ⇒ 압축률을 상당히 떨어뜨림.
- 암호화된 테이블의 데이터 페이지는 복호화된 상태로 InnoDB버퍼 풀에 저장되지만, 압축된 데이터 페이지는 압축 또는 압축 해제의 모든 상태로 InnoDB버퍼 풀에 존재할 수 있다.

### 암호화와 복제

복제에서 레플리카 서버는 소스 서버의 모든 사용자 데이터를 동기화하기 때문에 실제 데이터 파일도 동일할 것이라 생각할 수 있지만, TDE를 이용한 암호화 사용시 마스터 키와 테이블스페이스 키는 그렇지 않는다. 서로 다른 키를 가진다. 따라서 백업마다 키링 파일의 백업도 함께 고려해야 한다.

## 언두 로그 및 리두 로그 암호화

테이블의 암호화를 적용하더라도 디스크로 저장되는 데이터만 암호화되고 MySQL 서버의 메모리에 존재하는 데이터는 복호화된 평문으로 관리된다. 그래서 테이블 암호화를 적용해도 리두 로그나 언두 로그, 그리고 복제를 위한 바이너리 로그에는 평문으로 저장되는 것이다. MySQL 8.0.16버전 부터는 innodb_undo_log_encrypt시스템 변수와 innodb_redo_log_encrypt 시스템 변수를 이용해 InnoDB 스토리지 엔진의 리두 로그와 언두 로그를 암호화 된 상태로 저장할 수 있게 개선되었다.

## 바이너리 로그 암호화

일반적으로 언두 로그와 리두 로그는 길지 않은 시간 동안의 데이터만 가지기 때문에 크게 보안에 민감하지 않을 수 있지만 바이너리 로그는 의도적으로 상당히 긴 시간동안 보관하는 서비스도 있고 때로는 증분 백업을 위해 바이너리 로그를 보관하기도 한다. 이런 이유로 바이너리 로그 파일의 암호화는 상황에 따라 중요도가 높아질 수 있다.

### mysqlbinlog도구 활용

MySQL 서버에서는 트랜잭션의 내용을 추적하거나 백업 복구를 위해 암호화된 바이너리 로그를 평문으로 복호화할 일이 자주 발생한다. 바이너리 로그 암호화 키는 MySQL 서버만 가지고 있어서 복호화가 불가능하다. mysqlbinlog 도구가 MySQL 서버에 접속해서 바이너리 로그를 가져오는 방법밖에 없다.